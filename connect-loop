#!/usr/bin/env bash

. "$HOME/.bashrc"

## connect and autoreconnect
##
##
## (using mmcli 1.18.6)
## <massimo.manzato@gmail.com>

cd  /dev/shm/ || exit
wd=$(dirname $0)
cp "$wd/sites.list" .

. "$wd/mmcli_cl_functions"

#trap 'disconnectx' SIGINT SIGQUIT SIGABRT SIGKILL SIGTERM
#trap 'disconnectx' SIGINT SIGQUIT SIGABRT SIGTERM

	#rfkill unblock all
	#sleep 2
	#ifconfig wifi0 192.168.1.254/24 up

sv restart ModemManager
atime=$(date +%s)
connectx
sleep 3

while true
do
	check
	if [[ ! $result == 'yes' ]]; then
		echo "not connected."
		echo -n > /dev/shm/NOT-CONNECTED
		connectx
		sleep 5
	fi

	im=$(mmcli -L |grep -m 1 "Modem" |cut -d/ -f6 |awk '{print $1}')
	ib=$(mmcli -m "$im" |grep -m 1 "Bearer" |cut -d/ -f6)
	declare -A arrayA="( $(mmcli -K --bearer $ib | awk '{ printf "[\"%s\"]=\"%s\" ", $1, $3}' ) )"
	site1=$(shuf sites.list | head -1)
  testtime=$(date +%T)

	printf "%s Connected time: %s  Testing.. %s: " "$testtime" "${arrayA[bearer.stats.duration]}" "$site1"
	if [ "${arrayA[bearer.stats.duration]}" -gt 14340 ]; then
		printf "Restart Bearer ..."
		mmcli -b "$ib" -x
		mmcli -b "$ib" -c
		setIPandROUTE
	fi
	#echo -n "$testtime  Testing.. $site1: "
	testping1=$(ping -4 -s 1 -c 6 -W 1 -n "$site1" | grep " bytes" -c )
	#testping2=$(ping -4 -s 1 -c 6 -i 4 -W 4 -w 20  -n "$(shuf sites.list | head -1)" |grep "9 bytes" -c )
	testping2=$(ping -4 -s 1 -c 6 -W 1 -n 8.8.8.8  | grep "9 bytes" -c )

	if [ "$testping1" -gt 0 ] || [ "$testping2" -gt 0 ]; then
		printf "connected.\n"
		[[ -e /dev/shm/NOT-CONNECTED ]] && rm /dev/shm/NOT-CONNECTED
		sleep 2 &
		wait $!
	else
		echo "not connected."
		echo -n > /dev/shm/NOT-CONNECTED
		bearer -x
		sleep 1
	fi
done

